<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>สมัครสมาชิก • PFP ENGINEERING</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css" />
  <style>
    .card.reg{padding:0;overflow:hidden}
    .reg-head{padding:18px 22px;background:linear-gradient(180deg,#f9fafb 0%,#f3f4f6 100%);border-bottom:1px solid #eef2f7;display:flex;gap:10px;align-items:center}
    .reg-head .badge{font-size:12px;color:#64748b;background:#e2e8f0;border-radius:999px;padding:2px 10px}
    .reg-body{padding:20px}

    .reg-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:14px 18px;
      align-items:end; /* ขอบล่างเสมอกันในแต่ละแถว */
    }
    @media (min-width:900px){
      .reg-grid{grid-template-columns:1fr 1fr}
    }
    .field{display:grid;gap:6px}
    .field label{color:var(--muted)}

    .text-input{
      box-sizing:border-box;width:100%;
      border:1px solid #e5e7eb;background:#fff;
      padding:12px 14px;border-radius:12px;outline:none;
      transition:border .15s,box-shadow .15s;font:inherit
    }
    .text-input:focus{border-color:#93c5fd;box-shadow:0 0 0 3px rgba(59,130,246,.15)}

    .input-wrap{position:relative}
    .input-wrap > .text-input{padding-right:60px} /* เผื่อปุ่ม “แสดง” */
    .toggle-pass{
      position:absolute;right:12px;top:50%;transform:translateY(-50%);
      font-size:.9em;cursor:pointer;color:var(--muted);user-select:none
    }

    .error{background:#fff5f5;border:1px solid #fecaca;color:#b91c1c;padding:10px 12px;border-radius:10px}
    .hint{color:var(--muted);font-size:.9em}

    /* แถบวัดความแข็งแรง */
    .pw-row{grid-column:1/-1;display:grid;gap:8px}
    .pw-meter{height:6px;border-radius:6px;background:#eef2f7;overflow:hidden}
    .pw-meter > span{display:block;height:100%;width:0}
    .pw-weak{background:#ef4444}
    .pw-fair{background:#f59e0b}
    .pw-good{background:#22c55e}
    .pw-strong{background:#3b82f6}

    .actions{grid-column:1/-1;display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:4px}
  </style>
</head>
<body>
  <%- include('../partials/header') %>

  <main class="container" style="max-width:900px;padding:32px 0;">
    <h1 style="margin-bottom:14px">สมัครสมาชิก</h1>

    <% if (typeof error !== 'undefined' && error) { %>
      <div class="error" style="margin-bottom:16px;"><%= error %></div>
    <% } %>

    <form class="card reg" method="post" action="/auth/register" onsubmit="return checkPasswords()">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <input type="hidden" name="next" value="<%= next || '/' %>">

      <div class="reg-head">
        <strong>สร้างบัญชีใหม่</strong>
        <span class="badge">ปลอดภัยด้วยการแฮชรหัสผ่าน</span>
      </div>

      <div class="reg-body">
        <div class="reg-grid">
          <!-- แถว 1: ชื่อ / อีเมล -->
          <div class="field">
            <label for="name">ชื่อ</label>
            <input id="name" name="name" type="text" required autocomplete="name"
                   class="text-input" placeholder="ชื่อ-นามสกุล"
                   value="<%= (values && values.name) || '' %>">
          </div>

          <div class="field">
            <label for="email">อีเมล</label>
            <input id="email" name="email" type="email" required autocomplete="email"
                   class="text-input" placeholder="name@example.com"
                   value="<%= (values && values.email) || '' %>">
          </div>

          <!-- แถว 2: รหัสผ่าน / ยืนยันรหัสผ่าน -->
          <div class="field">
            <label for="password">รหัสผ่าน</label>
            <div class="input-wrap">
              <input id="password" name="password" type="password" minlength="6" required
                     class="text-input" autocomplete="new-password" placeholder="อย่างน้อย 6 ตัวอักษร">
              <span id="toggleP1" class="toggle-pass">แสดง</span>
            </div>
          </div>

          <div class="field">
            <label for="password2">ยืนยันรหัสผ่าน</label>
            <div class="input-wrap">
              <input id="password2" name="password2" type="password" minlength="6" required
                     class="text-input" autocomplete="new-password">
              <span id="toggleP2" class="toggle-pass">แสดง</span>
            </div>
          </div>

          <!-- แถว 3: แถบวัดความแข็งแรง (กิน 2 คอลัมน์) -->
          <div class="pw-row">
            <div class="pw-meter" aria-hidden="true"><span id="pwBar"></span></div>
            <div class="hint" id="pwHint">ความแข็งแรง: -</div>
            <small id="pwHelp" style="color:#b91c1c;display:none;">รหัสผ่านไม่ตรงกัน</small>
          </div>

          <!-- แถว 4: ปุ่ม -->
          <div class="actions">
            <button class="btn" type="submit">สมัครสมาชิก</button>
            <span class="hint">มีบัญชีอยู่แล้ว?
              <a href="/auth/login<%= next ? ('?next=' + encodeURIComponent(next)) : '' %>">เข้าสู่ระบบ</a>
            </span>
          </div>
        </div>
      </div>
    </form>
  </main>

  <%- include('../partials/footer') %>

  <script>
    function checkPasswords() {
      const p1 = document.getElementById('password').value.trim();
      const p2 = document.getElementById('password2').value.trim();
      const help = document.getElementById('pwHelp');
      const ok = p1 && p2 && p1 === p2;
      help.style.display = ok ? 'none' : 'block';
      return ok;
    }

    (function () {
      const bindToggle = (btnId, inputId) => {
        const $btn = document.getElementById(btnId);
        const $inp = document.getElementById(inputId);
        if ($btn && $inp) {
          $btn.addEventListener('click', () => {
            const isPwd = $inp.type === 'password';
            $inp.type = isPwd ? 'text' : 'password';
            $btn.textContent = isPwd ? 'ซ่อน' : 'แสดง';
          });
        }
      };
      bindToggle('toggleP1', 'password');
      bindToggle('toggleP2', 'password2');
    }());

    (function () {
      const $pw = document.getElementById('password');
      const $bar = document.getElementById('pwBar');
      const $hint = document.getElementById('pwHint');

      const score = (s) => {
        let n = 0;
        if (s.length >= 6) n++;
        if (/[A-Z]/.test(s)) n++;
        if (/[a-z]/.test(s)) n++;
        if (/[0-9]/.test(s)) n++;
        if (/[^A-Za-z0-9]/.test(s)) n++;
        return Math.min(n, 4);
      };
      const label = ['อ่อนมาก','อ่อน','ดี','ดีมาก','แข็งแรง'];

      const paint = (val) => {
        const sc = score(val);
        const widths = ['0%','25%','50%','75%','100%'];
        const classes = ['pw-weak','pw-weak','pw-fair','pw-good','pw-strong'];
        $bar.className = classes[sc];
        $bar.style.width = widths[sc];
        $hint.textContent = 'ความแข็งแรง: ' + label[sc];
      };

      $pw && $pw.addEventListener('input', (e) => paint(e.target.value));
      paint('');
    }());
  </script>
</body>
</html>
