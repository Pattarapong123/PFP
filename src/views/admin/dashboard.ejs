<%- include('partials/head', { title: '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î ‚Ä¢ PFP' }) %>

<style>
  :root{
    --gap:14px;
    --radius:14px;
  }

  /* ====== 4 ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà) ====== */
  .stat-grid{
    display:grid; gap:var(--gap);
    grid-template-columns: repeat(4, minmax(0,1fr));
  }
  @media (max-width: 1200px){ .stat-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
  @media (max-width: 680px){ .stat-grid{ grid-template-columns: 1fr; } }

  /* ‡∏ó‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ */
  .stat-card{
    display:flex; align-items:center; gap:14px;
    padding:18px; border:1px solid var(--border); border-radius:var(--radius);
    background:var(--panel); box-shadow: var(--shadow);
    min-height:92px;
    text-decoration:none; color:inherit;          /* ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: a ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î */
    transition: transform .08s ease, box-shadow .12s ease, border-color .12s ease;
  }
  .stat-card:hover{
    transform: translateY(-2px);
    border-color: color-mix(in oklab, var(--primary) 22%, var(--border));
    box-shadow: 0 10px 24px rgba(16,24,40,.10);
  }

  .stat-ico{
    width:54px; height:54px; border-radius:12px; flex:0 0 auto;
    display:grid; place-items:center; font-size:24px; font-weight:900;
    background: var(--primary-50); color: var(--primary-700); border:1px solid var(--primary-100);
  }
  .stat-meta{ display:flex; flex-direction:column; line-height:1.25; }
  .stat-meta .label{ color:var(--muted); font-size:12px; letter-spacing:.2px; }
  .stat-meta .value{ font-size:24px; font-weight:900; letter-spacing:.2px; }
  .stat-sub{ font-size:13px; color:var(--muted); margin-top:2px; }

  /* ===== ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° (‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ) ===== */
  .todo-grid{
    display:grid; gap:12px; grid-template-columns: repeat(2, minmax(0,1fr));
  }
  @media (max-width:900px){ .todo-grid{ grid-template-columns: 1fr; } }

  .todo-card{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:12px 14px; border:1px solid var(--border); border-radius:12px; background:var(--panel);
    min-height:68px;
  }
  .todo-title{ font-weight:900; }
  .todo-meta{ color:var(--muted); font-size:13px; }

  .admin-grid{
    display:grid; gap:var(--gap);
    grid-template-columns: minmax(0,2fr) minmax(280px,1fr);
    align-items:start;
  }
  @media (max-width: 1120px){ .admin-grid{ grid-template-columns: 1fr; } }

  .admin-card{ border-radius:var(--radius); }

  .mini-table{ width:100%; border-collapse:collapse; }
  .mini-table th, .mini-table td{
    padding:10px 12px; border-bottom:1px solid var(--border); vertical-align:middle;
  }
  .mini-table th{
    text-align:left; color:var(--muted); font-weight:800;
    background: color-mix(in oklab, var(--primary) 6%, transparent);
  }
  .mini-table tr:last-child td{ border-bottom:0; }
  .td-right{ text-align:right; white-space:nowrap; }

  .admin-chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); font-weight:800; }
  .admin-chip .dot{ width:8px; height:8px; border-radius:50%; background:currentColor; display:inline-block; }
  .admin-chip--warn{ background:#fff7ed; color:#9a3412; border-color:#fed7aa; }
  .admin-chip--ok{ background:#eff6ff; color:#1d4ed8; border-color:#bfdbfe; }
  .admin-chip--danger{ background:#fef2f2; color:#991b1b; border-color:#fecaca; }

  .log-title{ font-weight:800; }
  .log-meta{ color:var(--muted); font-size:12px; }

  .spark{ font-size:12px; color:var(--muted); }
</style>

<main class="admin-main">

  <!-- Header -->
  <div class="page-header">
    <div>
      <nav class="admin-breadcrumbs" aria-label="Breadcrumb">
        <a href="/admin">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</a><span>/</span><span>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</span>
      </nav>
      <h1 style="margin:6px 0 0;">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</h1>
    </div>
  </div>

  <!-- Stat cards (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î + ‡πÄ‡∏≠‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏Å) -->
  <section class="stat-grid" aria-label="‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥">
    <a class="stat-card" href="/admin/products" aria-label="‡∏î‡∏π‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
      <div class="stat-ico">üì¶</div>
      <div class="stat-meta">
        <span class="label">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
        <span class="value"><%= productCount %> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        <span class="stat-sub">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
      </div>
    </a>

    <a class="stat-card" href="/admin/orders" aria-label="‡∏î‡∏π‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå">
      <div class="stat-ico">üßæ</div>
      <div class="stat-meta">
        <span class="label">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</span>
        <span class="value"><%= orderCount %> ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</span>
        <span class="stat-sub">‡∏î‡∏π‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
      </div>
    </a>

    <a class="stat-card" href="/admin/portfolio" aria-label="‡∏î‡∏π‡∏ú‡∏•‡∏á‡∏≤‡∏ô">
      <div class="stat-ico">üñºÔ∏è</div>
      <div class="stat-meta">
        <span class="label">‡∏ú‡∏•‡∏á‡∏≤‡∏ô (Portfolio)</span>
        <span class="value"><%= portfolioCount %> ‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô</span>
        <span class="stat-sub">‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ</span>
      </div>
    </a>

    <a class="stat-card" href="/admin/orders?status=PAID" aria-label="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ">
      <div class="stat-ico">üí∞</div>
      <div class="stat-meta">
        <span class="label">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (PAID)</span>
        <span class="value">7 ‡∏ß‡∏±‡∏ô: <%= revenue7.toLocaleString('th-TH', {minimumFractionDigits:2}) %> ‡∏ø</span>
        <span class="stat-sub">30 ‡∏ß‡∏±‡∏ô: <%= revenue30.toLocaleString('th-TH', {minimumFractionDigits:2}) %> ‡∏ø</span>
      </div>
    </a>
  </section>

  <!-- Action Center (‡πÄ‡∏î‡∏¥‡∏°) -->
  <section class="admin-card" style="margin-top:var(--gap);">
    <div class="card-title">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ (Action Center)</div>
    <div class="todo-grid">
      <div class="todo-card">
        <div>
          <div class="todo-title">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ</div>
          <div class="todo-meta">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ PENDING ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏ô‡∏ö</div>
        </div>
        <div class="admin-right" style="display:flex;align-items:center;gap:10px;">
          <strong><%= pendingPaymentCount %></strong>
          <a class="admin-btn" href="/admin/orders?status=PENDING">‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π</a>
        </div>
      </div>

      <div class="todo-card">
        <div>
          <div class="todo-title">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</div>
          <div class="todo-meta">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ PAID</div>
        </div>
        <div class="admin-right" style="display:flex;align-items:center;gap:10px;">
          <strong><%= toShipCount %></strong>
          <a class="admin-btn" href="/admin/orders?status=PAID">‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π</a>
        </div>
      </div>
    </div>
  </section>

  <!-- Content: Left (wide) + Right (narrow) ‚Äì ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏î‡∏¥‡∏° -->
  <section class="admin-grid" style="margin-top:var(--gap);">
    <div class="admin-card">
      <div class="card-title">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>

      <div style="max-height:340px; overflow:auto; border:1px solid var(--border); border-radius:8px;">
        <table class="mini-table" style="margin:0;">
          <thead style="position:sticky;top:0;background:var(--panel);z-index:1;">
            <tr>
              <th style="width:48%;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
              <th style="width:22%;">‡∏´‡∏°‡∏ß‡∏î</th>
              <th style="width:16%;">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</th>
              <th style="width:14%;" class="td-right">‡πÄ‡∏ß‡∏•‡∏≤</th>
            </tr>
          </thead>
          <tbody>
            <% const hasLogs = Array.isArray(logs) && logs.length > 0; %>
            <% if (!hasLogs) { %>
              <tr><td colspan="4" style="text-align:center;">‚Äî ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ‚Äî</td></tr>
            <% } else { %>
              <% logs.forEach(l => { %>
                <tr>
                  <td>
                    <div class="log-title"><%= l.message %></div>
                    <% if (l.refId) { %><div class="log-meta">‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: #<%= l.refId %></div><% } %>
                  </td>
                  <td>
                    <span class="admin-chip"><span class="dot"></span><%= l.type %></span>
                  </td>
                  <td>
                    <span class="admin-chip <%= l.action === 'deleted' ? 'admin-chip--danger' : (l.action === 'updated' ? 'admin-chip--warn' : 'admin-chip--ok') %>">
                      <span class="dot"></span><%= l.action %>
                    </span>
                  </td>
                  <td class="td-right">
                    <time data-time="<%= l.createdAt?.toISOString ? l.createdAt.toISOString() : l.createdAt %>">
                      <%= new Date(l.createdAt).toLocaleString('th-TH') %>
                    </time>
                  </td>
                </tr>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>

      <p class="admin-muted" style="margin-top:8px;font-size:13px;">
        * ‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á <code>ActivityLog</code> (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ‡∏ú‡∏•‡∏á‡∏≤‡∏ô, ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö)
      </p>

      <hr style="margin:14px 0; border:none; border-top:1px solid var(--border);" />

      <div class="card-title" style="margin-top:0;">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
      <div style="overflow:auto; border:1px solid var(--border); border-radius:8px;">
        <table class="mini-table" style="margin:0;">
          <thead>
            <tr>
              <th>#</th>
              <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th class="td-right">‡∏¢‡∏≠‡∏î</th>
              <th class="td-right">‡πÄ‡∏ß‡∏•‡∏≤</th>
              <th class="td-right">‡∏î‡∏π</th>
            </tr>
          </thead>
          <tbody>
            <% if (!recentOrders || recentOrders.length === 0) { %>
              <tr><td colspan="6" style="text-align:center;">‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî</td></tr>
            <% } else { %>
              <% recentOrders.forEach(o => { %>
                <tr>
                  <td><%= o.id %></td>
                  <td><%= o.email %></td>
                  <td>
                    <span class="admin-chip <%= o.status === 'CANCELLED' ? 'admin-chip--danger' : (o.status === 'SHIPPED' ? 'admin-chip--ok' : (o.status === 'PAID' ? 'admin-chip--warn' : '')) %>">
                      <span class="dot"></span><%= o.status %>
                    </span>
                  </td>
                  <td class="td-right"><%= o.totalBaht.toLocaleString('th-TH', {minimumFractionDigits:2}) %> ‡∏ø</td>
                  <td class="td-right"><%= new Date(o.createdAt).toLocaleString('th-TH') %></td>
                  <td class="td-right"><a class="admin-btn admin-btn--soft" href="/admin/orders/<%= o.id %>">‡πÄ‡∏õ‡∏¥‡∏î</a></td>
                </tr>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- RIGHT: Quick links + Low stock -->
    <aside class="admin-card">
      <div class="card-title">‡∏ó‡∏≤‡∏á‡∏•‡∏±‡∏î</div>
      <div class="quick-list" style="display:flex; flex-direction:column; gap:10px;">
        <div class="todo-card"><div>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><a href="/admin/orders" class="admin-btn">‡πÄ‡∏õ‡∏¥‡∏î</a></div>
        <div class="todo-card"><div>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ (<%= pendingPaymentCount %>)</div><a href="/admin/orders?status=PENDING" class="admin-btn">‡πÄ‡∏õ‡∏¥‡∏î</a></div>
        <div class="todo-card"><div>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (<%= toShipCount %>)</div><a href="/admin/orders?status=PAID" class="admin-btn">‡πÄ‡∏õ‡∏¥‡∏î</a></div>
        <div class="todo-card"><div>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div><a href="/admin/products" class="admin-btn">‡πÄ‡∏õ‡∏¥‡∏î</a></div>
        <div class="todo-card"><div>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å</div><a href="/admin/stock" class="admin-btn">‡πÄ‡∏õ‡∏¥‡∏î</a></div>
        <div class="todo-card"><div>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</div><a href="/admin/units" class="admin-btn">‡πÄ‡∏õ‡∏¥‡∏î</a></div>
      </div>

      <hr style="margin:14px 0; border:none; border-top:1px solid var(--border);" />

      <div class="card-title" style="margin-top:0;">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</div>
      <div style="overflow:auto; border:1px solid var(--border); border-radius:8px;">
        <table class="mini-table" style="margin:0;">
          <thead>
            <tr><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="td-right">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th class="td-right">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
          </thead>
          <tbody>
            <% if (!lowStock || lowStock.length === 0) { %>
              <tr><td colspan="3" style="text-align:center;">‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î ‚Äî</td></tr>
            <% } else { %>
              <% lowStock.forEach(p => { %>
                <tr>
                  <td><a class="link-strong" href="/admin/products/<%= p.id %>/edit"><%= p.name %></a></td>
                  <td class="td-right"><%= p.stockQty %></td>
                  <td class="td-right"><a class="admin-btn admin-btn--soft" href="/admin/stock#prod-<%= p.id %>">‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å</a></td>
                </tr>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>
    </aside>
  </section>

</main>

<script>
  // relative time
  (function(){
    const els = document.querySelectorAll('time[data-time]');
    const rtf = new Intl.RelativeTimeFormat('th-TH', { numeric: 'auto' });
    const intervals = [
      ['year',   1000*60*60*24*365],
      ['month',  1000*60*60*24*30],
      ['day',    1000*60*60*24],
      ['hour',   1000*60*60],
      ['minute', 1000*60],
      ['second', 1000],
    ];
    function rel(d){
      const diff = new Date(d).getTime() - Date.now();
      const abs = Math.abs(diff);
      for(const [unit, ms] of intervals){
        if (abs >= ms || unit === 'second') return rtf.format(Math.round(diff/ms), unit);
      }
    }
    els.forEach(el=>{
      const iso = el.getAttribute('data-time');
      el.title = new Date(iso).toLocaleString('th-TH');
      el.textContent = rel(iso);
    });
  })();
</script>

<%- include('partials/foot') %>
