<!-- src/views/admin/products/new.ejs -->
<%- include('../partials/head', { title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚Ä¢ PFP' }) %>

<main class="admin-main">

  <!-- Page Header -->
  <div class="page-header admin-main">
    <div>
      <nav class="admin-breadcrumbs" aria-label="Breadcrumb">
        <a href="/admin">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</a>
        <span>/</span>
        <a href="/admin/products">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a>
        <span>/</span>
        <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
      </nav>
      <h1 style="margin:6px 0 0;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
      <% if (typeof createdAt === 'string') { %>
        <p class="admin-muted" style="margin:6px 0 0;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</p>
      <% } %>
    </div>
    <div class="admin-btn-group">
      <a href="/admin/products" class="admin-btn admin-btn--soft">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</a>
    </div>
  </div>

  <!-- ‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) -->
  <% if (errors) { %>
    <section class="admin-card" style="max-width: 920px; margin: 0 auto; border-color: color-mix(in oklab, var(--danger) 28%, var(--border));">
      <div class="admin-chip admin-chip--danger" style="margin-bottom:8px;">
        <span class="dot"></span>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
      </div>
      <div style="color:var(--danger-600);">
        <% if (Array.isArray(errors)) { errors.forEach(e => { %>
          <div>‚Ä¢ <%= e %></div>
        <% }) } else { %>
          <div><%= errors %></div>
        <% } %>
      </div>
    </section>
  <% } %>

  <!-- Form Card -->
  <section class="admin-card" style="max-width: 920px; margin: 0 auto;">

    <form method="post"
          action="/admin/products"
          enctype="multipart/form-data"
          style="display:grid; gap:16px;">

      <!-- CSRF -->
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">

      <%
        // ===== ‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö sticky form =====
        const v = (typeof values === 'object' && values) ? values : {};
        const selectedCats = Array.isArray(v.categoryIds) ? v.categoryIds.map(String) : [];
        const primaryCatId = v.primaryCategoryId != null ? String(v.primaryCategoryId) : '';
        // ‡∏ä‡πà‡∏ß‡∏¢‡∏ó‡∏≥ label ‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö (‡∏ñ‡πâ‡∏≤‡∏™‡πà‡∏á level ‡∏°‡∏≤‡∏à‡∏≤‡∏Å server)
        function catLabel(c){
          const lvl = Number(c.level || 0);
          let prefix = '';
          for (let i=0;i<lvl;i++) prefix += '‚Äî ';
          return prefix + c.name;
        }
        // ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏µ array categories ‡πÄ‡∏™‡∏°‡∏≠
        const catList = Array.isArray(categories) ? categories : [];
      %>

      <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
      <div class="admin-form-group">
        <label class="admin-label" for="name">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
        <input id="name" name="name" required class="admin-input"
               value="<%= v.name || '' %>"
               placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡∏™‡∏π‡∏á ‡∏£‡∏∏‡πà‡∏ô X200" />
      </div>

      <!-- Slug + SKU + ‡∏£‡∏≤‡∏Ñ‡∏≤ -->
      <div class="admin-form-grid-3">
        <div class="admin-form-group">
          <label class="admin-label" for="slug">Slug</label>
          <input id="slug" name="slug" class="admin-input"
                 value="<%= v.slug || '' %>"
                 placeholder="‡πÄ‡∏ä‡πà‡∏ô x200-high-pressure-pump" />
        </div>

        <div class="admin-form-group">
          <label class="admin-label" for="sku">SKU</label>
          <input id="sku" name="sku" class="admin-input"
                 value="<%= v.sku || '' %>"
                 placeholder="‡πÄ‡∏ä‡πà‡∏ô X200-HP-TH" />
        </div>

        <div class="admin-form-group">
          <label class="admin-label" for="priceBaht">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
          <div class="admin-input-group">
            <span class="affix">‡∏ø</span>
            <input id="priceBaht" name="priceBaht" class="admin-input"
                   type="number" step="0.01" min="0"
                   value="<%= (v.priceBaht != null ? v.priceBaht : '') %>"
                   placeholder="0.00" />
          </div>
        </div>
      </div>

      <!-- ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö -->
      <div class="admin-field">
        <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</label>
        <select class="admin-select" name="unitId">
          <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢ ‚Äî</option>
          <% (units || []).forEach(u => { %>
            <option value="<%= u.id %>" <%= String(v.unitId || '') === String(u.id) ? 'selected' : '' %>>
              <%= u.name %><%= u.shortName ? ' ('+u.shortName+')' : '' %>
            </option>
          <% }) %>
        </select>
        <div class="hint">‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÑ‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà ‚Äú‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö‚Äù ‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</div>
      </div>

      <!-- ===================== ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÉ‡∏´‡∏°‡πà) ===================== -->
      <div class="admin-grid-2" style="gap:14px;">
        <!-- ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å -->
        <div class="admin-field">
          <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å (‡πÉ‡∏ä‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Ñ‡∏ï‡∏ï‡∏≤‡∏•‡πá‡∏≠‡∏Å/‡∏Å‡∏£‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å)</label>
          <select class="admin-select" name="primaryCategoryId">
            <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å ‚Äî</option>
            <% catList.forEach(c => { %>
              <option value="<%= c.id %>" <%= primaryCatId === String(c.id) ? 'selected' : '' %>><%= catLabel(c) %></option>
            <% }) %>
          </select>
          <div class="hint">‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÅ‡∏ï‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏à‡∏±‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô</div>
        </div>

        <!-- ‡∏´‡∏°‡∏ß‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß) -->
        <div class="admin-field">
          <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° <span class="admin-muted">(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span></label>
          <select class="admin-select" id="categoryIds" name="categoryIds[]" multiple size="6">
            <% catList.forEach(c => { %>
              <option value="<%= c.id %>" <%= selectedCats.includes(String(c.id)) ? 'selected' : '' %>><%= catLabel(c) %></option>
            <% }) %>
          </select>
          <div class="hint">‡∏Å‡∏î Ctrl/Command + ‡∏Ñ‡∏•‡∏¥‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
        </div>
      </div>
      <!-- =============================================================== -->

      <!-- ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û -->
      <div class="admin-form-group">
        <label class="admin-label">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>

        <!-- Dropzone/Picker -->
        <div id="dropzone" class="admin-dropzone" tabindex="0" role="button" aria-label="‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û">
          <div class="dz-icon">üñºÔ∏è</div>
          <div class="dz-text">‡∏•‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</div>
          <div class="dz-subtext">PNG / JPG / WebP / GIF ‚â§ 5MB</div>
          <input id="imageFile" name="imageFile" type="file" accept="image/*" style="display:none" />
        </div>

        <!-- Current + Preview -->
        <div class="admin-media-duo" style="margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div class="admin-preview">
            <div class="admin-muted" style="margin-bottom:6px;">‡∏£‡∏π‡∏õ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
            <div class="admin-muted" style="border:1px dashed var(--border); border-radius:12px; padding:16px; text-align:center;">
              ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ (‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
            </div>
          </div>

          <div class="admin-preview">
            <div class="admin-muted" style="margin-bottom:6px;">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà</div>
            <img id="preview" src="" alt=""
                 style="display:none; max-height:180px; width:auto; border-radius:12px; box-shadow:var(--shadow); border:1px solid var(--border); background:#fff; padding:6px;">
          </div>
        </div>
      </div>

      <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î -->
      <div class="admin-form-group">
        <label class="admin-label" for="description">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
        <textarea id="description" name="description" class="admin-textarea" rows="6"
                  placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πÄ‡∏õ‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"><%= v.description || '' %></textarea>
      </div>

      <!-- Actions -->
      <div class="admin-form-actions">
        <button class="admin-btn admin-btn--lg" type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
        <a href="/admin/products" class="admin-btn admin-btn--soft admin-btn--lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</a>
      </div>
    </form>
  </section>
</main>

<script>
  (function () {
    // ===== Dropzone preview =====
    const dz = document.getElementById('dropzone');
    const picker = document.getElementById('imageFile');
    const preview = document.getElementById('preview');

    function showPreview(file) {
      if (!file) {
        preview.style.display = 'none';
        preview.src = '';
        return;
      }
      if (!file.type || !file.type.startsWith('image/')) { alert('‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô'); return; }
      if (file.size > 5 * 1024 * 1024) { alert('‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB'); return; }
      const url = URL.createObjectURL(file);
      preview.src = url;
      preview.style.display = 'block';
    }

    dz.addEventListener('click', () => picker.click());
    dz.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); picker.click(); }
    });

    picker.addEventListener('change', () => {
      const f = picker.files?.[0];
      showPreview(f);
    });

    // Drag & drop
    ['dragenter','dragover'].forEach(evt =>
      dz.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); dz.classList.add('is-dragover'); })
    );
    ['dragleave','drop'].forEach(evt =>
      dz.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); dz.classList.remove('is-dragover'); })
    );
    dz.addEventListener('drop', (e) => {
      const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
      if (f) {
        picker.files = e.dataTransfer.files;
        showPreview(f);
      }
    });

    // ===== UX: ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô multiple select (‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°) =====
    const multi = document.getElementById('categoryIds');
    if (multi) {
      const hint = multi.parentElement.querySelector('.hint');
      const update = () => {
        const count = Array.from(multi.options).filter(o => o.selected).length;
        if (hint) hint.innerHTML = (count ? `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ¬∑ ` : '') + '‡∏Å‡∏î Ctrl/Command + ‡∏Ñ‡∏•‡∏¥‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
      };
      multi.addEventListener('change', update);
      update();
    }
  })();
</script>

<%- include('../partials/foot') %>
