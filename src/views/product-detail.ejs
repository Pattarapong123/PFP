<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title><%= (product && product.name ? product.name : 'สินค้า') %> • PFP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css" />
  <link rel="icon" type="image/jpeg" href="/images/logo2.jpg" />

  <style>
    /* ====== Layout ====== */
    .pd-wrap{ padding:24px 0; }
    .pd-grid{ display:grid; gap:28px; grid-template-columns: 1.1fr .9fr; align-items:start; }
    @media (max-width: 980px){ .pd-grid{ grid-template-columns:1fr; } }

    /* ====== Back bar ====== */
    .back-bar{ display:flex; align-items:center; gap:10px; margin-bottom:14px; }
    .back-btn{
      display:inline-flex; align-items:center; gap:10px;
      background: var(--primary, #2563eb); color:#fff; text-decoration:none;
      padding:10px 16px; border-radius: 999px; font-weight:800; font-size:15px;
      box-shadow:0 6px 18px rgba(0,0,0,.18); transition: transform .2s ease, background .2s ease;
    }
    .back-btn:hover{ background:#1d4ed8; transform: translateY(-1px); }
    .back-btn svg{ width:18px; height:18px; stroke-width:2.5; }

    /* ====== Media/Gallery ====== */
    .pd-media{ display:grid; gap:12px; }
    .pd-hero{
      width:100%; aspect-ratio: 4 / 3; object-fit:contain; background:#f7f8fc;
      border:1px solid var(--border); border-radius:16px; box-shadow: var(--shadow); padding:10px;
    }
    .pd-thumbs{ display:flex; gap:10px; overflow:auto; scrollbar-width: thin; padding-bottom:2px; }
    .pd-thumb{
      flex:0 0 auto; width:84px; height:64px; object-fit:cover;
      border:1px solid var(--border); border-radius:10px; box-shadow:var(--shadow);
      opacity:.8; cursor:pointer; transition:.12s; background:#fff;
    }
    .pd-thumb:hover{ transform: translateY(-2px); opacity:1; }
    .pd-thumb.is-active{ outline:2px solid var(--primary); opacity:1; }

    /* ====== Text / Price ====== */
    .pd-title{ margin:6px 0 8px; }
    .pc-meta{ color:var(--muted); font-size:13px; }
    .price-row{ display:flex; flex-wrap:wrap; align-items:center; gap:10px; margin:10px 0 6px; }
    .price-lg{ font-size:28px; font-weight:900; letter-spacing:.3px; }

    /* ====== Stock ====== */
    .stock-row{ display:flex; align-items:center; gap:10px; color:var(--muted); }
    .stock-pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; border:1px solid var(--border);
      background: var(--panel); font-size:12px; font-weight:800; white-space:nowrap;
    }
    .stock-pill .dot{ width:8px; height:8px; border-radius:50%; background: currentColor; }
    .stock-ok{ color: var(--success-600); }
    .stock-low{ color: var(--warning-600); }
    .stock-out{ color: var(--danger-600); }

    /* ====== Info card ====== */
    .detail-info-card{
      margin-top:14px; padding:14px; border-radius:14px; border:1px solid var(--border); background:#fff; box-shadow: var(--shadow);
    }
    .detail-info-card .card-title{ font-weight:900; margin-bottom:6px; }

    /* ====== Actions / Qty ====== */
    .primary-actions{ margin-top:12px; }
    .qty-control{
      display:inline-flex; align-items:center; gap:10px;
      padding:8px; border:1px solid var(--border); border-radius:14px;
      background: var(--panel); box-shadow: var(--shadow);
    }
    .qty-btn{
      width:44px; height:44px; display:grid; place-items:center;
      font-size:22px; font-weight:900; line-height:1;
      border-radius:12px; cursor:pointer; user-select:none;
      background: var(--primary-50, #eef2ff);
      color: var(--primary-700, #3c51b3);
      border:1px solid var(--primary-100, #e0e7ff);
      transition: background .15s ease, border-color .15s ease, transform .03s ease, box-shadow .18s ease;
    }
    .qty-btn:hover{ background: var(--primary-100, #e0e7ff); }
    .qty-btn:active{ transform: translateY(1px); }
    .qty-btn:focus-visible{ outline:3px solid color-mix(in oklab, var(--primary) 45%, transparent); outline-offset:2px; }
    .qty-control input{
      width:96px; height:44px; text-align:center; font-weight:900; font-size:18px;
      padding:0 12px; border:1px solid var(--border); border-radius:12px; background:#fff;
      font-variant-numeric: tabular-nums;
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
    input[type="number"]{ -moz-appearance: textfield; }

    .btn{
      display:inline-flex; align-items:center; gap:8px; border-radius:12px; padding:12px 16px; border:1px solid var(--border); cursor:pointer;
      font-weight:800;
    }
    .btn--primary{ background: var(--primary, #2563eb); color:#fff; border-color: color-mix(in oklab, var(--primary) 70%, #0000); }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; }

    /* ===== Toast ===== */
    .toast{
      position: fixed; right: 22px; bottom: 22px; background: var(--primary, #3b82f6); color: #fff;
      padding: 12px 16px 12px 14px; border-radius: 14px; box-shadow: 0 14px 36px rgba(0,0,0,.18);
      opacity: 0; transform: translateY(18px) scale(.98); transition: opacity .28s ease, transform .28s ease;
      z-index: 9999; font-size: 14px; font-weight: 700; display: flex; align-items: center; gap: 10px;
    }
    .toast.show{ opacity: 1; transform: translateY(0) scale(1); }
    .toast-icon{ width: 22px; height: 22px; flex: 0 0 22px; }
    .toast-text{ line-height: 1.2; }
  </style>
</head>
<body>
  <%- include('partials/header') %>

  <main class="container pd-wrap">
    <div class="back-bar">
      <a href="/products" class="back-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M15 18l-6-6 6-6" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        ย้อนกลับไปหน้าสินค้า
      </a>
    </div>

    <section class="pd-grid">
      <%
        const imgs = (product && product.images && product.images.length ? product.images : []);
        const heroSrc = (imgs[0] && imgs[0].url) ? imgs[0].url : '/images/placeholder.png';
        const unitLabel = (product && product.unit ? (product.unit.shortName || product.unit.name) : 'ชิ้น');
        const qty = Number.isFinite(product && product.stockQty) ? (product.stockQty || 0) : 0;
        const stockClass = qty <= 0 ? 'stock-out' : (qty <= 5 ? 'stock-low' : 'stock-ok');
      %>

      <!-- Media / Gallery -->
      <div class="pd-media">
        <img id="pd-hero" class="pd-hero" src="<%= heroSrc %>" alt="<%= product.name %>">
        <div class="pd-thumbs" id="pd-thumbs">
          <% if (!imgs.length) { %>
            <img class="pd-thumb is-active" src="/images/placeholder.png" alt="placeholder">
          <% } %>
          <% imgs.forEach(function(im, idx){ %>
            <img
              class="pd-thumb <%= idx === 0 ? 'is-active' : '' %>"
              src="<%= im.url %>"
              data-full="<%= im.url %>"
              alt="ภาพ <%= product.name %> <%= idx+1 %>">
          <% }) %>
        </div>
      </div>

      <!-- Detail -->
      <div>
        <h1 class="pd-title"><%= product.name %></h1>

        <% if (product && product.model) { %>
          <div class="pc-meta">รุ่น: <%= product.model %></div>
        <% } %>
        <% if (product && product.system) { %>
          <div class="pc-meta">สเปก/ระบบ: <%= product.system %></div>
        <% } %>

        <!-- ราคา + SKU -->
        <div class="price-row">
          <div class="price-lg">
            <%= Number(product.price).toLocaleString('th-TH', { minimumFractionDigits: 2 }) %> บาท
          </div>
          <% if (product && product.sku) { %>
            <span class="stock-pill">SKU: <%= product.sku %></span>
          <% } %>
        </div>

        <!-- สต๊อก -->
        <div class="stock-row" style="margin:6px 0 14px;">
          <span class="stock-pill <%= stockClass %>">
            <span class="dot"></span>
            คงเหลือ: <strong><%= qty %></strong> <%= unitLabel %>
          </span>
          <% if (qty <= 0) { %><span class="stock-out">สินค้าหมด</span>
          <% } else if (qty <= 5) { %><span class="stock-low">คงเหลือน้อย</span>
          <% } else { %><span class="stock-ok">พร้อมจำหน่าย</span><% } %>
        </div>

        <!-- คำอธิบาย -->
        <% if (product && product.description) { %>
          <div class="detail-info-card">
            <div class="card-title">รายละเอียด</div>
            <div><%- product.description %></div>
          </div>
        <% } %>

        <!-- ซื้อ -->
        <div class="primary-actions">
          <form id="add-to-cart-form" method="post" action="/cart/add">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <input type="hidden" name="productId" value="<%= product.id %>">

            <div class="qty-control">
              <button type="button" class="qty-btn" aria-label="ลดจำนวน" onclick="chg(-1)">−</button>
              <input id="qty" name="qty" type="number" min="1" value="1" inputmode="numeric" pattern="[0-9]*" aria-live="polite">
              <button type="button" class="qty-btn" aria-label="เพิ่มจำนวน" onclick="chg(1)">＋</button>
            </div>

            <button class="btn btn--primary" style="margin-top:10px;" <%= canBuy ? '' : 'disabled' %>>
              <%= canBuy ? 'หยิบใส่ตะกร้า' : 'สินค้าหมด' %>
            </button>
          </form>
        </div>
      </div>
    </section>
  </main>

  <%- include('partials/footer') %>

  <script>
    // ----- Gallery switcher -----
    (function(){
      const hero = document.getElementById('pd-hero');
      const list = document.getElementById('pd-thumbs');
      if (!hero || !list) return;
      list.addEventListener('click', (e) => {
        const t = e.target;
        if (!(t && t.classList && t.classList.contains('pd-thumb'))) return;
        const full = t.getAttribute('data-full') || t.src;
        if (full) hero.src = full;
        list.querySelectorAll('.pd-thumb.is-active').forEach(el => el.classList.remove('is-active'));
        t.classList.add('is-active');
      });
    })();

    // ----- Qty control & stock guard -----
    const maxQty = <%- JSON.stringify(Math.max(0, qty)) %>;
    function chg(n){
      const el = document.getElementById('qty');
      let v = parseInt(el.value || '1', 10);
      if (Number.isNaN(v)) v = 1;
      v = v + n;
      v = Math.max(1, Math.min(v, maxQty || 1));
      el.value = v;
    }
    function guardQty(){
      if (maxQty <= 0) return false;
      const el = document.getElementById('qty');
      let v = parseInt(el.value || '1', 10);
      if (v > maxQty) { el.value = maxQty; v = maxQty; }
      return v > 0 && v <= maxQty;
    }

    // ----- Toast helper -----
    function showToast(msg){
      const box = document.getElementById('toast');
      const text = document.getElementById('toast-text');
      if(!box || !text) return;
      text.textContent = msg;
      box.classList.add('show');
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=> box.classList.remove('show'), 2600);
    }

    // ----- Add-to-cart (AJAX first, fallback to normal submit) -----
    (function(){
      const form = document.getElementById('add-to-cart-form');
      if(!form) return;

      form.addEventListener('submit', async function(ev){
        // ถ้าสต๊อกไม่พอ ให้หยุดเลย
        if (!guardQty()) { ev.preventDefault(); return; }

        // พยายามยิง AJAX ก่อน
        ev.preventDefault();
        try {
          const productId = Number(form.querySelector('input[name="productId"]').value);
          const qty = Number(document.getElementById('qty').value || 1);

          const res = await fetch('/cart/add', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'              // 👈 บอกเซิร์ฟเวอร์ให้คืน JSON
            },
            body: JSON.stringify({ productId, qty })
          });

          if (res.ok) {
            const data = await res.json().catch(()=> ({}));
            if (data && data.ok) {
              // อัปเดต badge ตะกร้า
              const badge = document.getElementById('cartCount');
              if (badge && typeof data.cartCount !== 'undefined') {
                badge.textContent = data.cartCount;
              }
              showToast('✅ เพิ่มสินค้าลงตะกร้าแล้ว');
              return; // จบแบบ AJAX
            }
          }
          // ถ้าไม่ได้ JSON ok ให้ fallback ส่งฟอร์มปกติ
          form.submit();
        } catch (err) {
          // เผื่อหลุด error ก็ fallback
          form.submit();
        }
      });
    })();
  </script>

  <!-- Toast container -->
  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true">
    <span class="toast-icon">✔</span>
    <span id="toast-text" class="toast-text"></span>
  </div>
</body>
</html>
